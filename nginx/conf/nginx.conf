worker_processes  1;

events {
    worker_connections  1024;
}

# 引入Lua模块
lua_package_path "/usr/local/nginx/lua/?.lua;;";

# 配置共享内存
lua_shared_dict agent_cache 10m;
lua_shared_dict policy_cache 10m;
lua_shared_dict rate_limit 10m;

# HTTP配置
http {
    include       mime.types;
    default_type  application/octet-stream;
    
    sendfile        on;
    keepalive_timeout  65;
    
    # 日志格式
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for" '
                      '$request_time';
    
    access_log  logs/access.log  main;
    error_log  logs/error.log  error;
    
    # 引入代理配置
    include conf.d/proxy.conf;
    
    # 引入安全配置
    include conf.d/security.conf;
    
    # Nginx状态监控
    server {
        listen       8081;
        server_name  localhost;
        
        location /status {
            stub_status on;
            access_log off;
            allow 127.0.0.1;
            deny all;
        }
    }
}

# TCP配置
tcp {
    include conf.d/tcp_proxy.conf;
}

# UDP配置
udp {
    include conf.d/udp_proxy.conf;
}